# Vault Secrets Operator
# Automatically syncs secrets from Vault to Kubernetes

---
# VaultConnection (cluster-scoped)
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultConnection
metadata:
  name: vault-connection
  namespace: vault
spec:
  address: "http://vault.vault:8200"
  
  # Skip TLS verification (only for development)
  skipTLSVerify: true

---
# VaultAuth for production namespace
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultAuth
metadata:
  name: vault-auth
  namespace: production
spec:
  vaultConnectionRef: vault-connection
  
  method: kubernetes
  mount: kubernetes
  
  kubernetes:
    role: app-backend
    serviceAccount: api-service-account

---
# VaultStaticSecret for app-backend config
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: app-backend-secrets
  namespace: production
spec:
  vaultAuthRef: vault-auth
  
  mount: secret
  type: kv-v2
  path: app-backend/config
  
  # Refresh interval
  refreshAfter: 30s
  
  # Destination Kubernetes Secret
  destination:
    name: app-backend-secrets
    create: true
    
  # Rollout restart on secret change
  rolloutRestartTargets:
  - kind: Deployment
    name: app-backend

---
# VaultDynamicSecret for database credentials
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultDynamicSecret
metadata:
  name: app-backend-db-creds
  namespace: production
spec:
  vaultAuthRef: vault-auth
  
  mount: database
  path: creds/app-backend
  
  # Renew before expiration
  renewalPercent: 67  # Renew at 67% of TTL
  
  # Destination Secret
  destination:
    name: app-backend-db-creds
    create: true
  
  # Rollout restart when credentials rotate
  rolloutRestartTargets:
  - kind: Deployment
    name: app-backend

---
# VaultAuth for workers
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultAuth
metadata:
  name: worker-vault-auth
  namespace: production
spec:
  vaultConnectionRef: vault-connection
  
  method: kubernetes
  mount: kubernetes
  
  kubernetes:
    role: worker
    serviceAccount: worker-service-account

---
# VaultStaticSecret for worker config
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: worker-secrets
  namespace: production
spec:
  vaultAuthRef: worker-vault-auth
  
  mount: secret
  type: kv-v2
  path: worker/config
  
  refreshAfter: 30s
  
  destination:
    name: worker-secrets
    create: true
    
  rolloutRestartTargets:
  - kind: Deployment
    name: worker

---
# VaultDynamicSecret for worker database credentials
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultDynamicSecret
metadata:
  name: worker-db-creds
  namespace: production
spec:
  vaultAuthRef: worker-vault-auth
  
  mount: database
  path: creds/worker
  
  renewalPercent: 67
  
  destination:
    name: worker-db-creds
    create: true
  
  rolloutRestartTargets:
  - kind: Deployment
    name: worker
