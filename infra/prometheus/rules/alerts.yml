# Prometheus Alert Rules for High Availability Monitoring

groups:
- name: high_availability
  interval: 30s
  rules:
  
  # Node availability
  - alert: NodeDown
    expr: up{job="kubernetes-nodes"} == 0
    for: 2m
    labels:
      severity: critical
      component: infrastructure
    annotations:
      summary: "Node {{ $labels.instance }} is down"
      description: "Kubernetes node {{ $labels.instance }} has been down for more than 2 minutes"
      runbook_url: "https://docs.ytvideocreator.com/runbooks/node-down"
  
  - alert: NodeNotReady
    expr: kube_node_status_condition{condition="Ready",status="true"} == 0
    for: 5m
    labels:
      severity: warning
      component: infrastructure
    annotations:
      summary: "Node {{ $labels.node }} is not ready"
      description: "Node {{ $labels.node }} has been in NotReady state for more than 5 minutes"
  
  # Pod health
  - alert: PodCrashLooping
    expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
    for: 5m
    labels:
      severity: warning
      component: application
    annotations:
      summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
      description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} has restarted {{ $value }} times in the last 15 minutes"
  
  - alert: PodNotReady
    expr: kube_pod_status_phase{phase!~"Running|Succeeded"} > 0
    for: 10m
    labels:
      severity: warning
      component: application
    annotations:
      summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} not ready"
      description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} has been in {{ $labels.phase }} state for more than 10 minutes"
  
  # Application latency
  - alert: HighLatency
    expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) > 1
    for: 5m
    labels:
      severity: warning
      component: performance
    annotations:
      summary: "High P99 latency on {{ $labels.job }}"
      description: "P99 latency is {{ $value }}s (threshold: 1s) for {{ $labels.job }}"
  
  - alert: VeryHighLatency
    expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) > 5
    for: 2m
    labels:
      severity: critical
      component: performance
    annotations:
      summary: "Very high P99 latency on {{ $labels.job }}"
      description: "P99 latency is {{ $value }}s (critical threshold: 5s) for {{ $labels.job }}"
  
  # Database health
  - alert: DatabaseDown
    expr: pg_up == 0
    for: 1m
    labels:
      severity: critical
      component: database
    annotations:
      summary: "PostgreSQL is down"
      description: "PostgreSQL database {{ $labels.instance }} has been down for more than 1 minute"
      runbook_url: "https://docs.ytvideocreator.com/runbooks/database-down"
  
  - alert: DatabaseReplicationLag
    expr: pg_replication_lag > 10
    for: 5m
    labels:
      severity: warning
      component: database
    annotations:
      summary: "PostgreSQL replication lag is high"
      description: "Replication lag is {{ $value }} seconds on {{ $labels.instance }}"
  
  # Cache health
  - alert: RedisDown
    expr: redis_up == 0
    for: 1m
    labels:
      severity: critical
      component: cache
    annotations:
      summary: "Redis is down"
      description: "Redis instance {{ $labels.instance }} has been down for more than 1 minute"
      runbook_url: "https://docs.ytvideocreator.com/runbooks/redis-down"
  
  - alert: RedisMasterMissing
    expr: redis_instance_info{role="master"} == 0
    for: 2m
    labels:
      severity: critical
      component: cache
    annotations:
      summary: "Redis has no master"
      description: "Redis cluster has no master instance"
  
  # Resource utilization
  - alert: HighCPUUsage
    expr: node_cpu_seconds_total{mode="user"} / node_cpu_seconds_total > 0.8
    for: 10m
    labels:
      severity: warning
      component: resources
    annotations:
      summary: "High CPU usage on {{ $labels.instance }}"
      description: "CPU usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"
  
  - alert: HighMemoryUsage
    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.9
    for: 10m
    labels:
      severity: warning
      component: resources
    annotations:
      summary: "High memory usage on {{ $labels.instance }}"
      description: "Memory usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"
  
  - alert: DiskSpaceLow
    expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
    for: 5m
    labels:
      severity: warning
      component: resources
    annotations:
      summary: "Low disk space on {{ $labels.instance }}"
      description: "Disk usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}:{{ $labels.mountpoint }}"
  
  # Error rates
  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
    for: 5m
    labels:
      severity: warning
      component: application
    annotations:
      summary: "High error rate on {{ $labels.job }}"
      description: "Error rate is {{ $value | humanizePercentage }} on {{ $labels.job }}"
  
  # Deployment issues
  - alert: DeploymentReplicasMismatch
    expr: kube_deployment_spec_replicas != kube_deployment_status_replicas_available
    for: 15m
    labels:
      severity: warning
      component: deployment
    annotations:
      summary: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} has mismatched replicas"
      description: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} has {{ $value }} available replicas (expected: {{ $labels.spec_replicas }})"
