groups:
  - name: application_alerts
    interval: 30s
    rules:
      # High Error Rate Alert
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(jobs_completed_total{status="failed"}[5m]))
            /
            sum(rate(jobs_completed_total[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: warning
          component: jobs
        annotations:
          summary: "High job failure rate detected"
          description: "Job failure rate is {{ $value | humanizePercentage }} (threshold: 5%)"
      
      # High Latency Alert
      - alert: HighLatency
        expr: |
          histogram_quantile(0.99, 
            sum(rate(job_duration_seconds_bucket[5m])) by (le, job_type)
          ) > 30
        for: 10m
        labels:
          severity: warning
          component: performance
        annotations:
          summary: "High job latency detected"
          description: "P99 latency for {{ $labels.job_type }} is {{ $value }}s (threshold: 30s)"
      
      # Batch Failure Alert
      - alert: BatchProcessingFailure
        expr: |
          increase(batches_completed_total{status="failed"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
          component: batch
        annotations:
          summary: "Batch processing failure detected"
          description: "{{ $value }} batch(es) failed in the last 5 minutes"
      
      # LLM Error Rate Alert
      - alert: LLMHighErrorRate
        expr: |
          (
            sum(rate(llm_requests_total{status="failure"}[5m]))
            /
            sum(rate(llm_requests_total[5m]))
          ) > 0.10
        for: 5m
        labels:
          severity: warning
          component: llm
        annotations:
          summary: "High LLM error rate"
          description: "LLM error rate is {{ $value | humanizePercentage }} (threshold: 10%)"
      
      # Cache Performance Alert
      - alert: LowCacheHitRate
        expr: |
          (
            sum(rate(cache_hits_total[5m]))
            /
            (sum(rate(cache_hits_total[5m])) + sum(rate(cache_misses_total[5m])))
          ) < 0.50
        for: 15m
        labels:
          severity: info
          component: cache
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }} (threshold: 50%)"
      
      # Resource Saturation Alert
      - alert: HighActiveJobs
        expr: active_jobs > 100
        for: 5m
        labels:
          severity: warning
          component: resources
        annotations:
          summary: "High number of active jobs"
          description: "{{ $value }} active jobs detected (threshold: 100)"
      
      # Database Connection Alert
      - alert: DatabaseConnectionIssue
        expr: |
          increase(errors_total{error_code="DB_001"}[5m]) > 5
        for: 2m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Database connection errors detected"
          description: "{{ $value }} database connection errors in last 5 minutes"
      
      # Service Availability
      - alert: ServiceDown
        expr: up{job="story-genius"} == 0
        for: 1m
        labels:
          severity: critical
          component: availability
        annotations:
          summary: "Service is down"
          description: "Story-Genius service is not responding to health checks"
